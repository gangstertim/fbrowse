var events = require('events');
var fs = require('fs');
var path = require('path');
var jade = require('jade');
var util = require('util');
var mime = require('mime');

// Template engine for displaying files
var gen_files_view = jade.compile([
    '- each file in files',
    '  .file(data-path="#{file.path}")',
    '    .icon',
    '      img(src="icons/#{file.type}.png")',
    '    .name #{file.name}',
].join('\n'));

//Template engine for displaying folders
var gen_folders_view = jade.compile([
    '- each folder in folders',
    '  div.panel.panel-primary(data-path="#{folder.path}", id=folder.id)',
    // '    .icon',
    // '      img(src="icons/#{folder.type}.png")',
    '    .panel-heading',
    '      .panel-title #{folder.name}',
    //'    .panel-body', //this is where the files go
].join('\n'));

// Template engine for displaying files in subfolders
var gen_small_files_view = jade.compile([
    '- each file in files',
    '  .file(data-path="#{file.path}")',
    '    .smallicon',
    '      img(src="icons/#{file.type}.png")',
    '    .name #{file.name}',
].join('\n'));

// Our type
function Folder(jquery_element) {
  events.EventEmitter.call(this);
  this.element = jquery_element;

  var self = this;
  // Click on blank
  this.element.parent().on('click', function() {
    self.element.find('.focus').removeClass('focus');
  });
  // Click on file
  this.element.delegate('.file', 'click', function(e) {
    self.element.find('.focus').removeClass('focus');
    $(this).addClass('focus');
    e.stopPropagation();
  });
  // Double click on file
  this.element.delegate('.file', 'dblclick', function() {
    var file_path = $(this).attr('data-path');
    self.emit('navigate', file_path, mime.stat(file_path));
  });

  // Click on panel-heading
  this.element.delegate('.panel.panel-primary', 'click', function(e) {
    self.element.find('.focus').removeClass('focus');
    $(this).addClass('focus');
    e.stopPropagation();
  });
}

util.inherits(Folder, events.EventEmitter);


Folder.prototype.open = function(dir) {

  var self = this;
  fs.readdir(dir, function(error, contents) {
    if (error) {
      console.log(error);
      window.alert(error);
      return;
    }

    var fileCount = 0;
    var folderCount = 0;
    var files = [];
    var folders = [];

    for (var i = 0; i < contents.length; ++i) {
      contents[i] = mime.stat(path.join(dir, contents[i]));
      if (contents[i].type == 'folder')  {
        folders[folderCount] = contents[i];
        folders[folderCount].id = "folder" + folderCount++;
      } else {
        files[fileCount++] = contents[i]; 
      }
    }

    $('#files').html(gen_files_view({ files: files}));
    $('#folders').html(gen_folders_view({ folders: folders}));

    for (var i = 0; i < folderCount; ++i) {
      (function (folderNum) {
        var dataPath = $('#folder' + folderNum).attr('data-path');
        fs.readdir(dataPath, function(error, contents) {
          if (error) {
            console.log(error);
            window.alert(error);
            return;
          }

          for (var j = 0; j < contents.length; ++j) {
            contents[j] = mime.stat(path.join(dataPath, contents[j]));
          }

          var folderContents = gen_small_files_view({ files: contents }) ;

          $('#folder' + folderNum).append('<div class="panel-body">' + folderContents + '</div>');
        });  
      }(i));
    }

  });
}

exports.Folder = Folder; 
